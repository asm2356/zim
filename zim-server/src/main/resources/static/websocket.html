<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script type="text/javascript" src="lib/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="lib/protobuf.min.js"></script>
<script type="text/javascript" src="js/chat.js"></script>
<script type="text/javascript" src="lib/reconnecting-websocket.min.js"></script>
<form onsubmit="return false">
    <label>
        <textarea name="message" style="height: 300px; width: 300px"></textarea>
    </label>
    <input type="button" value="发生消息" id="sendBtn">
    <label for="responseText">
        <textarea id="responseText" style="height: 300px; width: 300px"></textarea>
    </label>
    <input type="button" value="清空内容" onclick="document.getElementById('responseText').value=''">
</form>
<form onsubmit="return false">
    <label for="fromId">
        formId
        <input type="text" autocomplete="off" id="fromId">
    </label>
    <label>
        toId
        <input type="text" autocomplete="off" id="toId">
    </label>
</form>

<form onsubmit="return false">
    <input name="username" type="text"/>
    <input type="password" value="1234" name="pwd">
    <input type="button" value="登录" id="login">
    <input type="button" value="注销" id="loginOut">
</form>
<script type="text/javascript">
    var baseMessage;//解码器
    var message;//是具体的某个定义的proto实例是一个8位无符号的字节数组
    var buffer;
    var token = getItem("token");
    protobuf.load("protocol/base_message.proto", function (err, root) {
        if (err) throw err;
        baseMessage = root.lookup("protocol.Message");
    });

    function createMessage(obj) {
        if (!baseMessage) {
            return;
        }
        message = baseMessage.create(obj);
        var errMsg = baseMessage.verify(message);
        if (errMsg) {
            console.log("error" + errMsg);
            throw Error(errMsg);
        }
        buffer = baseMessage.encode(message).finish();
        return buffer;
    }

    var socket;

    function initSocket() {
        if (!window.WebSocket) {
            console.log("不支持websocket");
            return;
        }
        /**
         * open()
         * close(code, reason)
         * refresh()
         * send(data)
         */
        var socket = new WebSocket("ws://127.0.0.1:9999/");
        socket.onmessage = function (event) {
            if (event.data instanceof ArrayBuffer) {
                console.log("二进制数据");
            } else {
                console.log("普通文本数据");
            }
            var receiveReader = new FileReader();
            receiveReader.readAsArrayBuffer(event.data);
            receiveReader.onload = function (e) {
                var buf = new Uint8Array(receiveReader.result);
                var message = baseMessage.decode(buf);
                var content = message.content;
                $("#responseText").val($("#responseText").val() + "\n" + content);
            };
        };
        //连接建立的回调函数
        socket.onopen = function (event) {
            var ta = document.getElementById("responseText");
            ta.value = "连接开启";
            connectLogin();
        };
        //连接断掉的回调函数
        socket.onclose = function (event) {
            var ta = document.getElementById("responseText");
            ta.value = ta.value + "\n" + "连接关闭";
            removeItem("token");
        };
        window.onbeforeunload = function () {
            socket.close();
        };
        return socket;
    }

    function connectLogin() {
        var obj = {
            fromId: $("#fromId").val(),
            toId: '',
            content: "content",
            sendTime: new Date().getTime(),
            messageType: 2,
            chatType: 1,
            terminalType: 1,
            files: null,
            protocol: "webSocket",
            token: getItem("token"),
            data: null
        };
        var buffer = createMessage(obj);
        if (socket) {
            socket.send(buffer);
        }
    }

    $("#login").on("click", function () {
        $.ajax({
            url: "http://127.0.0.1:8080/login",
            type: "POST",
            data: {
                username: $("input[name='username']").val(),
                pwd: $("input[name='pwd']").val()
            },
            success: function (result) {
                if (result.code === 200) {
                    var data = result.data;
                    var token = data["token"];
                    var personId = data["personId"];
                    $("#fromId").val(personId);
                    setItem("token", token);
                    socket = initSocket();
                    console.log("登录成功");
                }
            }
        });
    });
    $("#loginOut").on("click", function () {
        $.ajax({
            url: "http://127.0.0.1:8080/loginOut",
            type: "POST",
            success: function (result) {
                if (result.code === 200) {
                    removeItem("token", result.data);
                    console.log("注销成功")
                }
            }
        });
    });
    $("#sendBtn").on("click", function () {
        var content = $("textarea[name='message']").val();
        var obj = {
            fromId: $("#fromId").val(),
            toId: $("#toId").val(),
            content: content,
            sendTime: new Date().getTime(),
            messageType: 1,
            chatType: 2,
            terminalType: 1,
            files: null,
            protocol: "webSocket",
            token: getItem("token"),
            data: null
        };
        var buffer = createMessage(obj);
        if (socket) {
            socket.send(buffer);
        }
    });
</script>
</body>
</html>